<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Moon Phases — Cosmic Playground</title>
    <link rel="stylesheet" href="./style.css" />
    <link rel="stylesheet" href="../../assets/katex/katex.min.css" />
  </head>
  <body>
    <canvas class="cp-starfield" aria-hidden="true"></canvas>
    <div
      id="cp-demo"
      class="cp-layer-instrument cp-demo"
      data-shell="viz-first"
      aria-label="Moon phases instrument"
    >
      <aside class="cp-demo__controls cp-panel" aria-label="Controls panel">
        <div class="cp-panel-header">Moon Phases</div>
        <div class="cp-panel-body">
          <p class="cp-muted">
            The Moon is always half lit. Phases show how much of that lit half
            faces Earth.
          </p>

          <div id="challenge-container"></div>

          <label class="cp-field">
            <span class="cp-label">Phase angle alpha (deg)</span>
            <input
              id="angle"
              class="cp-range"
              type="range"
              min="0"
              max="360"
              value="90"
              step="1"
              data-tooltip-source="#angleReadout"
            />
          </label>

          <div class="cp-field">
            <span class="cp-label">Key phases</span>
            <div class="phase-buttons" role="group" aria-label="Key phases">
              <button class="cp-button cp-button--outline phase-btn" data-angle="180" type="button">
                New Moon
              </button>
              <button class="cp-button cp-button--outline phase-btn" data-angle="270" type="button">
                First Quarter
              </button>
              <button class="cp-button cp-button--outline phase-btn" data-angle="0" type="button">
                Full Moon
              </button>
              <button class="cp-button cp-button--outline phase-btn" data-angle="90" type="button">
                Third Quarter
              </button>
            </div>
          </div>

          <label class="cp-field">
            <input id="toggle-advanced" type="checkbox" />
            <span>Advanced: latitude/season</span>
          </label>

          <div id="advanced-controls" class="advanced-controls is-hidden">
            <label class="cp-field">
              <span class="cp-label">Latitude (deg)</span>
              <input id="latitude" class="cp-range" type="range" min="-90" max="90" value="0" step="1" />
              <div class="cp-muted"><span id="latitudeReadout">0</span> deg</div>
            </label>

            <label class="cp-field">
              <span class="cp-label">Day of year (1–365)</span>
              <input id="dayOfYear" class="cp-range" type="range" min="1" max="365" value="80" step="1" />
              <div class="cp-muted">Day <span id="dayOfYearReadout">80</span></div>
            </label>

            <div class="cp-field">
              <span class="cp-label">Season presets</span>
              <div class="preset-buttons" role="group" aria-label="Season presets">
                <button class="cp-button cp-button--outline" id="preset-spring" type="button">
                  Mar Equinox
                </button>
                <button class="cp-button cp-button--outline" id="preset-summer" type="button">
                  Jun Solstice
                </button>
                <button class="cp-button cp-button--outline" id="preset-fall" type="button">
                  Sept Equinox
                </button>
                <button class="cp-button cp-button--outline" id="preset-winter" type="button">
                  Dec Solstice
                </button>
              </div>
            </div>
          </div>

          <label class="cp-field">
            <input id="toggle-sky-view" type="checkbox" />
            <span>Show sky view</span>
          </label>

          <div class="cp-actions">
            <button class="cp-button" id="btn-station-mode" type="button">
              Station Mode
            </button>
            <button class="cp-button cp-button--outline" id="btn-help" type="button">
              Help / Keys
            </button>
          </div>

          <div class="cp-actions">
            <button class="cp-button cp-button--outline" id="btn-challenges" type="button">
              Challenges
            </button>
            <button id="copyResults" class="cp-button" type="button">Copy results</button>
          </div>

          <p id="status" class="cp-status" role="status" aria-live="polite" aria-atomic="true"></p>

          <details class="cp-accordion">
            <summary>
              <span class="cp-accordion__title">Insights (optional)</span>
              <span class="cp-accordion__meta">shadow</span>
            </summary>
            <div class="cp-accordion__body">
              <p>
                Earth’s shadow points away from the Sun and only matters during
                lunar eclipses.
              </p>
              <label class="shadow-toggle">
                <input type="checkbox" id="show-shadow-toggle" />
                <span>Show Earth’s Shadow (Eclipse insight)</span>
              </label>
              <p>
                Want the full story? Try
                <a href="../eclipse-geometry/">Eclipse Geometry</a>.
              </p>
            </div>
          </details>

          <div class="cp-actions">
            <a class="cp-button" href="../../exhibits/moon-phases/">Open exhibit</a>
            <a class="cp-button cp-button--outline" href="../../stations/moon-phases/">Station card</a>
            <a class="cp-button cp-button--outline" href="../../instructor/moon-phases/">Instructor notes</a>
          </div>
        </div>
      </aside>

      <section class="cp-demo__stage cp-stage" aria-label="Visualization stage">
        <div class="viz-layout">
          <div class="viz-panel">
            <div class="panel-title">View from Above (North Pole)</div>
            <svg id="orbital-svg" viewBox="0 0 400 400" preserveAspectRatio="xMidYMid meet">
              <defs>
                <radialGradient id="sunGlow" cx="50%" cy="50%" r="50%">
                  <stop offset="0%" stop-color="var(--cp-celestial-sun-core)" />
                  <stop offset="60%" stop-color="var(--cp-celestial-sun)" stop-opacity="0.6" />
                  <stop offset="100%" stop-color="var(--cp-celestial-sun)" stop-opacity="0" />
                </radialGradient>

                <radialGradient id="earthGradient" cx="30%" cy="30%">
                  <stop offset="0%" stop-color="var(--cp-celestial-earth)" />
                  <stop offset="100%" stop-color="var(--cp-celestial-earth-land)" />
                </radialGradient>

                <radialGradient id="moonLit" cx="30%" cy="30%">
                  <stop offset="0%" stop-color="var(--cp-celestial-moon)" />
                  <stop offset="100%" stop-color="var(--cp-celestial-moon-dark)" />
                </radialGradient>

                <clipPath id="moonClip">
                  <circle cx="0" cy="0" r="15" />
                </clipPath>

                <clipPath id="moonLitHalfClip" clipPathUnits="userSpaceOnUse">
                  <rect id="moon-lit-half-clip" x="305" y="185" width="15" height="30" />
                </clipPath>

                <filter id="sun-glow-filter" x="-50%" y="-50%" width="200%" height="200%">
                  <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur" />
                  <feMerge>
                    <feMergeNode in="blur" />
                    <feMergeNode in="SourceGraphic" />
                  </feMerge>
                </filter>
              </defs>

              <g id="sunlight-arrows" opacity="0.4">
                <line x1="0" y1="100" x2="80" y2="100" stroke="var(--cp-celestial-sun)" stroke-width="2" />
                <line x1="0" y1="200" x2="80" y2="200" stroke="var(--cp-celestial-sun)" stroke-width="2" />
                <line x1="0" y1="300" x2="80" y2="300" stroke="var(--cp-celestial-sun)" stroke-width="2" />
                <text x="10" y="60" fill="var(--cp-celestial-sun)" font-size="11">Sunlight -&gt;</text>
                <text x="10" y="72" fill="var(--cp-celestial-sun)" font-size="9" opacity="0.85">
                  from the Sun
                </text>
              </g>

              <circle cx="-60" cy="200" r="80" fill="url(#sunGlow)" opacity="0.8" filter="url(#sun-glow-filter)" />

              <circle
                cx="200"
                cy="200"
                r="120"
                fill="none"
                stroke="var(--cp-celestial-orbit)"
                stroke-width="1"
                stroke-dasharray="4 4"
                opacity="0.6"
              />

              <g id="earth-group" transform="translate(200, 200)">
                <circle r="25" fill="url(#earthGradient)" />
                <text y="45" text-anchor="middle" fill="var(--cp-muted)" font-size="11">Earth</text>
              </g>

              <g id="earth-shadow-group" style="display: none;">
                <defs>
                  <linearGradient id="shadowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="var(--cp-bg0)" stop-opacity="0.6" />
                    <stop offset="100%" stop-color="var(--cp-bg0)" stop-opacity="0" />
                  </linearGradient>
                </defs>
                <path
                  id="umbra-cone"
                  d="M 225 200 L 380 185 L 380 215 Z"
                  fill="var(--cp-bg0)"
                  fill-opacity="0.55"
                  stroke="none"
                />
                <path
                  id="penumbra-cone"
                  d="M 225 200 L 400 160 L 400 240 Z"
                  fill="url(#shadowGradient)"
                  stroke="var(--cp-muted)"
                  stroke-opacity="0.35"
                  stroke-width="1"
                  stroke-dasharray="4 2"
                />
                <text x="320" y="155" fill="var(--cp-celestial-sun)" font-size="10" opacity="0.8">
                  Earth's Shadow
                </text>
                <text x="300" y="168" fill="var(--cp-celestial-sun)" font-size="9" opacity="0.6">
                  (only matters for eclipses)
                </text>
              </g>

              <g
                id="moon-group"
                class="moon-draggable"
                role="slider"
                aria-label="Moon position on orbit"
                aria-valuemin="0"
                aria-valuemax="360"
                aria-valuenow="0"
                aria-valuetext="Full Moon, 100% illuminated"
                tabindex="0"
              >
                <circle id="moon-dark" cx="320" cy="200" r="15" fill="var(--cp-celestial-moon-dark)" />
                <circle id="moon-lit" cx="320" cy="200" r="15" fill="url(#moonLit)" clip-path="url(#moonLitHalfClip)" />
                <line
                  id="moon-terminator"
                  x1="320"
                  y1="185"
                  x2="320"
                  y2="215"
                  stroke="var(--cp-muted)"
                  stroke-width="1"
                  opacity="0.85"
                />
              </g>

              <g id="view-indicator" opacity="0.5">
                <path d="M 200 175 L 200 140" stroke="var(--cp-celestial-earth)" stroke-width="1" stroke-dasharray="3 3" />
                <text x="200" y="130" text-anchor="middle" fill="var(--cp-celestial-earth)" font-size="9">
                  Your view
                </text>
              </g>
            </svg>
            <div class="drag-hint">Drag the Moon around Earth’s orbit</div>
          </div>

          <div class="viz-panel">
            <div class="panel-title">As Seen from Earth</div>
            <svg id="phase-svg" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
              <defs>
                <radialGradient id="moonSurface" cx="30%" cy="30%">
                  <stop offset="0%" stop-color="var(--cp-celestial-moon)" />
                  <stop offset="100%" stop-color="var(--cp-celestial-moon-dark)" />
                </radialGradient>

                <radialGradient id="earthshine" cx="70%" cy="30%">
                  <stop offset="0%" stop-color="var(--cp-bg2)" />
                  <stop offset="100%" stop-color="var(--cp-bg3)" />
                </radialGradient>
              </defs>

              <g transform="translate(100, 100)">
                <circle r="60" fill="url(#earthshine)" />
                <path id="lit-portion" d="" fill="url(#moonSurface)" />
              </g>
            </svg>
            <div class="schematic-note">Schematic (not to scale).</div>
          </div>
        </div>

        <div id="sky-view-panel" class="sky-view-panel">
          <div class="panel-title">Sky view</div>
          <div id="sky-view" class="sky-view is-hidden">
            <svg id="sky-view-svg" viewBox="0 0 320 120" preserveAspectRatio="xMidYMid meet">
              <line
                id="sky-horizon"
                x1="20"
                y1="80"
                x2="300"
                y2="80"
                stroke="var(--cp-border)"
                stroke-width="2"
              />
              <line
                x1="20"
                y1="80"
                x2="20"
                y2="92"
                stroke="var(--cp-muted)"
                stroke-width="2"
              />
              <line
                x1="300"
                y1="80"
                x2="300"
                y2="92"
                stroke="var(--cp-muted)"
                stroke-width="2"
              />
              <text x="16" y="108" fill="var(--cp-muted)" font-size="10">E</text>
              <text x="296" y="108" fill="var(--cp-muted)" font-size="10">W</text>
              <circle id="sky-rise-marker" cx="60" cy="80" r="5" fill="var(--cp-celestial-earth)" />
              <circle id="sky-set-marker" cx="260" cy="80" r="5" fill="var(--cp-celestial-sun)" />
            </svg>
            <p id="sky-summary" class="cp-muted">Sky view shows rise/set along the horizon.</p>
          </div>
        </div>

        <div class="timeline-panel">
          <div class="timeline-header">
            <span class="timeline-direction" id="timeline-direction">WAXING -&gt;</span>
            <span class="timeline-day" id="timeline-day">Day 0 of 29.5</span>
          </div>
          <div class="timeline-strip" id="timeline-strip">
            <button class="timeline-phase" data-angle="180" type="button" aria-label="New Moon">
              <div class="phase-icon new-moon"></div>
              <span>New</span>
            </button>
            <button class="timeline-phase" data-angle="225" type="button" aria-label="Waxing Crescent">
              <div class="phase-icon waxing-crescent"></div>
              <span>Crescent</span>
            </button>
            <button class="timeline-phase" data-angle="270" type="button" aria-label="First Quarter">
              <div class="phase-icon first-quarter"></div>
              <span>1st Qtr</span>
            </button>
            <button class="timeline-phase" data-angle="315" type="button" aria-label="Waxing Gibbous">
              <div class="phase-icon waxing-gibbous"></div>
              <span>Gibbous</span>
            </button>
            <button class="timeline-phase" data-angle="0" type="button" aria-label="Full Moon">
              <div class="phase-icon full-moon"></div>
              <span>Full</span>
            </button>
            <button class="timeline-phase" data-angle="45" type="button" aria-label="Waning Gibbous">
              <div class="phase-icon waning-gibbous"></div>
              <span>Gibbous</span>
            </button>
            <button class="timeline-phase" data-angle="90" type="button" aria-label="Third Quarter">
              <div class="phase-icon third-quarter"></div>
              <span>3rd Qtr</span>
            </button>
            <button class="timeline-phase" data-angle="135" type="button" aria-label="Waning Crescent">
              <div class="phase-icon waning-crescent"></div>
              <span>Crescent</span>
            </button>
          </div>
        </div>

        <div class="animation-controls">
          <button class="cp-button" id="btn-play" type="button">▶ Play</button>
          <button class="cp-button cp-button--outline" id="btn-pause" type="button" disabled>
            ⏸ Pause
          </button>
          <button class="cp-button cp-button--outline" id="btn-step-back" type="button">⏮ Step</button>
          <button class="cp-button cp-button--outline" id="btn-step-forward" type="button">Step ⏭</button>
          <button class="cp-button cp-button--outline" id="btn-reset" type="button" title="Reset to Full Moon">
            ↺ Reset
          </button>
          <label class="speed-control" for="speed-select">
            <span>Speed</span>
            <select id="speed-select" class="cp-select">
              <option value="1">1x</option>
              <option value="5" selected>5x</option>
              <option value="10">10x</option>
            </select>
          </label>
        </div>
      </section>

      <aside class="cp-demo__readouts cp-panel" aria-label="Readouts panel">
        <div class="cp-panel-header">Readouts</div>
        <div class="cp-panel-body">
          <div class="cp-readout">
            <div class="cp-readout__label">Phase name</div>
            <div class="cp-readout__value" id="phase-name">Full Moon</div>
          </div>
          <div class="cp-readout">
            <div class="cp-readout__label">Phase angle &#x03B1;</div>
            <div class="cp-readout__value"><span id="angleReadout">0</span><span class="cp-readout__unit">deg</span></div>
          </div>
          <div class="cp-readout">
            <div class="cp-readout__label">Illumination fraction f</div>
            <div class="cp-readout__value" id="illumination-fraction">1.000</div>
          </div>
          <div class="cp-readout">
            <div class="cp-readout__label">Illuminated</div>
            <div class="cp-readout__value"><span id="illumination">100</span><span class="cp-readout__unit">%</span></div>
          </div>
          <div class="cp-readout">
            <div class="cp-readout__label">Days since new</div>
            <div class="cp-readout__value"><span id="days-since-new">14.8</span><span class="cp-readout__unit">d</span></div>
          </div>
          <div class="cp-readout">
            <div class="cp-readout__label">Waxing / Waning</div>
            <div class="cp-readout__value" id="waxing-waning">Waxing</div>
          </div>
          <div class="cp-readout">
            <div class="cp-readout__label">Moon rise</div>
            <div class="cp-readout__value"><span id="rise-time">--:--</span><span class="cp-readout__unit">LST</span></div>
          </div>
          <div class="cp-readout">
            <div class="cp-readout__label">Moon set</div>
            <div class="cp-readout__value"><span id="set-time">--:--</span><span class="cp-readout__unit">LST</span></div>
          </div>
          <div class="cp-readout">
            <div class="cp-readout__label">Rise / set status</div>
            <div class="cp-readout__value" id="rise-set-status">Local solar time</div>
          </div>
        </div>
      </aside>

      <section class="cp-demo__drawer cp-drawer" aria-label="Panels">
        <div class="cp-panels">
          <details class="cp-accordion" open>
            <summary>
              <span class="cp-accordion__title">What to notice</span>
              <span class="cp-accordion__meta">Observable -&gt; Model -&gt; Inference</span>
            </summary>
            <div class="cp-accordion__body">
              <ul>
                <li><strong>Observable:</strong> the lit fraction grows or shrinks as the Moon moves.</li>
                <li><strong>Model:</strong> illumination depends on the Sun–Earth–Moon phase angle $\alpha$.</li>
                <li><strong>Inference:</strong> phases are geometry, not Earth’s shadow.</li>
              </ul>
            </div>
          </details>

          <details class="cp-accordion">
            <summary>
              <span class="cp-accordion__title">Model notes</span>
              <span class="cp-accordion__meta">schematic</span>
            </summary>
            <div class="cp-accordion__body">
              <ul>
                <li>Schematic geometry (not to scale, no orbital tilt).</li>
                <li>Illumination uses $f = \frac{1 + \cos\alpha}{2}$ with $\alpha$ in degrees.</li>
                <li>Earth’s shadow appears only when toggled and only for eclipse insight.</li>
              </ul>
            </div>
          </details>
        </div>
      </section>
    </div>

    <script type="module" src="./main.ts"></script>
  </body>
</html>
