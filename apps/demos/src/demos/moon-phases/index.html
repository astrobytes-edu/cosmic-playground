<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Moon Phases — Cosmic Playground</title>
    <link rel="stylesheet" href="./style.css" />
    <link rel="stylesheet" href="../../assets/katex/katex.min.css" />
  </head>
  <body>
    <canvas class="cp-starfield" aria-hidden="true"></canvas>
    <div
      id="cp-demo"
      class="cp-layer-instrument cp-demo"
      aria-label="Moon phases instrument"
    >
      <!-- ═══════════════════════════════════════════
           SIDEBAR — physics controls
           ═══════════════════════════════════════════ -->
      <aside class="cp-demo__sidebar cp-panel" aria-label="Controls panel">
        <div class="cp-panel-header">Moon Phases</div>
        <div class="cp-panel-body cp-scroll-shadow">
          <div class="cp-utility-toolbar" role="toolbar" aria-label="Demo actions">
            <button class="cp-utility-btn" id="btn-station-mode" aria-label="Station mode" title="Station mode">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="4" y="2" width="12" height="16" rx="1.5"/>
                <line x1="7" y1="7" x2="13" y2="7"/>
                <line x1="7" y1="10" x2="13" y2="10"/>
                <line x1="7" y1="13" x2="10" y2="13"/>
              </svg>
            </button>
            <button class="cp-utility-btn" id="btn-help" aria-label="Help and shortcuts" title="Help / Keys">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="10" cy="10" r="8"/>
                <path d="M7.5 7.5a2.5 2.5 0 0 1 5 0c0 1.5-2.5 2-2.5 3.5"/>
                <circle cx="10" cy="15" r="0.75" fill="currentColor" stroke="none"/>
              </svg>
            </button>
            <button class="cp-utility-btn" id="btn-challenges" aria-label="Challenges" title="Challenges">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M10 2l2.2 4.5 5 .7-3.6 3.5.8 5L10 13.4 5.6 15.7l.8-5L2.8 7.2l5-.7z"/>
              </svg>
            </button>
            <button type="button" class="cp-utility-btn" id="copyResults" aria-label="Copy results" title="Copy results">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <rect x="6" y="6" width="10" height="12" rx="1.5"/>
                <path d="M14 6V3.5A1.5 1.5 0 0 0 12.5 2H5.5A1.5 1.5 0 0 0 4 3.5V14"/>
              </svg>
            </button>
            <div class="cp-popover-anchor">
              <button class="cp-utility-btn cp-popover-trigger" aria-label="Navigation" aria-expanded="false" aria-controls="navPopover" title="More links">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                  <circle cx="4" cy="10" r="1.5"/>
                  <circle cx="10" cy="10" r="1.5"/>
                  <circle cx="16" cy="10" r="1.5"/>
                </svg>
              </button>
              <div class="cp-popover" id="navPopover" hidden>
                <nav class="cp-popover__body">
                  <a class="cp-popover-link" href="../../exhibits/moon-phases/">Open exhibit</a>
                  <a class="cp-popover-link" href="../../stations/moon-phases/">Station card</a>
                  <a class="cp-popover-link" href="../../instructor/moon-phases/">Instructor notes</a>
                </nav>
              </div>
            </div>
          </div>

          <div id="challenge-container"></div>

          <label class="cp-field">
            <span class="cp-label">Phase angle &#x03B1; (deg)</span>
            <input
              id="angle"
              class="cp-range"
              type="range"
              min="0"
              max="360"
              value="90"
              step="1"
              data-tooltip-source="#angleReadout"
            />
          </label>

          <div class="cp-popover-anchor">
            <button class="cp-button cp-button--outline cp-popover-trigger" id="phase-presets-trigger"
                    aria-expanded="false" aria-controls="phasePresetsPopover" type="button">
              Phase presets...
            </button>
            <div class="cp-popover" id="phasePresetsPopover" hidden>
              <div class="cp-popover__body">
                <div class="phase-buttons" role="group" aria-label="Key phases">
                  <button class="cp-button cp-button--outline phase-btn" data-angle="180" type="button">
                    New Moon
                  </button>
                  <button class="cp-button cp-button--outline phase-btn" data-angle="270" type="button">
                    First Quarter
                  </button>
                  <button class="cp-button cp-button--outline phase-btn" data-angle="0" type="button">
                    Full Moon
                  </button>
                  <button class="cp-button cp-button--outline phase-btn" data-angle="90" type="button">
                    Third Quarter
                  </button>
                </div>
              </div>
            </div>
          </div>

          <label class="cp-field">
            <input id="toggle-advanced" type="checkbox" />
            <span>Advanced: latitude/season</span>
          </label>

          <div id="advanced-controls" class="advanced-controls is-hidden">
            <label class="cp-field">
              <span class="cp-label">Latitude (deg)</span>
              <input id="latitude" class="cp-range" type="range" min="-90" max="90" value="0" step="1" />
              <div class="cp-muted"><span id="latitudeReadout">0</span> deg</div>
            </label>

            <label class="cp-field">
              <span class="cp-label">Day of year (1-365)</span>
              <input id="dayOfYear" class="cp-range" type="range" min="1" max="365" value="80" step="1" />
              <div class="cp-muted">Day <span id="dayOfYearReadout">80</span></div>
            </label>

            <div class="cp-field">
              <span class="cp-label">Season presets</span>
              <div class="preset-buttons" role="group" aria-label="Season presets">
                <button class="cp-button cp-button--outline" id="preset-spring" type="button">
                  Mar Equinox
                </button>
                <button class="cp-button cp-button--outline" id="preset-summer" type="button">
                  Jun Solstice
                </button>
                <button class="cp-button cp-button--outline" id="preset-fall" type="button">
                  Sept Equinox
                </button>
                <button class="cp-button cp-button--outline" id="preset-winter" type="button">
                  Dec Solstice
                </button>
              </div>
            </div>
          </div>

          <label class="cp-field">
            <input id="toggle-rise-set" type="checkbox" />
            <span>Rise/set times</span>
          </label>

          <details class="cp-accordion">
            <summary>
              <span class="cp-accordion__title">Insights (optional)</span>
              <span class="cp-accordion__meta"></span>
            </summary>
            <div class="cp-accordion__body">
              <p>
                Earth's shadow points away from the Sun and only matters during
                lunar eclipses.
              </p>
              <label class="shadow-toggle">
                <input type="checkbox" id="show-shadow-toggle" />
                <span>Show Earth's Shadow (Eclipse insight)</span>
              </label>
              <p>
                Want the full story? Try
                <a href="../eclipse-geometry/">Eclipse Geometry</a>.
              </p>
            </div>
          </details>

          <p id="status" class="cp-status" role="status" aria-live="polite" aria-atomic="true"></p>
        </div>
      </aside>

      <!-- ═══════════════════════════════════════════
           VIZ — orbital + phase SVGs
           ═══════════════════════════════════════════ -->
      <section class="cp-demo__stage cp-stage" aria-label="Visualization stage">
        <div class="viz-layout">
          <div class="viz-panel">
            <div class="panel-title">View from Above (North Pole)</div>
            <svg id="orbital-svg" viewBox="0 45 400 280" preserveAspectRatio="xMidYMid meet">
              <defs>
                <radialGradient id="sunGlow" cx="50%" cy="50%" r="50%">
                  <stop offset="0%" stop-color="var(--cp-celestial-sun-core)" />
                  <stop offset="60%" stop-color="var(--cp-celestial-sun)" stop-opacity="0.6" />
                  <stop offset="100%" stop-color="var(--cp-celestial-sun)" stop-opacity="0" />
                </radialGradient>

                <radialGradient id="earthGradient" cx="30%" cy="30%">
                  <stop offset="0%" stop-color="var(--cp-celestial-earth)" />
                  <stop offset="100%" stop-color="var(--cp-celestial-earth-land)" />
                </radialGradient>

                <radialGradient id="moonLit" cx="30%" cy="30%">
                  <stop offset="0%" stop-color="var(--cp-celestial-moon)" />
                  <stop offset="100%" stop-color="var(--cp-celestial-moon-dark)" />
                </radialGradient>

                <clipPath id="moonClip">
                  <circle cx="0" cy="0" r="15" />
                </clipPath>

                <clipPath id="moonLitHalfClip" clipPathUnits="userSpaceOnUse">
                  <rect id="moon-lit-half-clip" x="305" y="185" width="15" height="30" />
                </clipPath>

                <filter id="sun-glow-filter" x="-50%" y="-50%" width="200%" height="200%">
                  <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur" />
                  <feMerge>
                    <feMergeNode in="blur" />
                    <feMergeNode in="SourceGraphic" />
                  </feMerge>
                </filter>
              </defs>

              <g id="sunlight-arrows" opacity="0.4">
                <line x1="0" y1="100" x2="80" y2="100" stroke="var(--cp-celestial-sun)" stroke-width="2" />
                <line x1="0" y1="200" x2="80" y2="200" stroke="var(--cp-celestial-sun)" stroke-width="2" />
                <line x1="0" y1="300" x2="80" y2="300" stroke="var(--cp-celestial-sun)" stroke-width="2" />
                <text x="10" y="60" fill="var(--cp-celestial-sun)" font-size="11">Sunlight -&gt;</text>
                <text x="10" y="72" fill="var(--cp-celestial-sun)" font-size="9" opacity="0.85">
                  from the Sun
                </text>
              </g>

              <circle cx="-60" cy="200" r="80" fill="url(#sunGlow)" opacity="0.8" filter="url(#sun-glow-filter)" />

              <circle
                cx="200"
                cy="200"
                r="120"
                fill="none"
                stroke="var(--cp-celestial-orbit)"
                stroke-width="1"
                stroke-dasharray="4 4"
                opacity="0.6"
              />

              <g id="earth-group" transform="translate(200, 200)">
                <circle r="25" fill="url(#earthGradient)" />
                <text y="45" text-anchor="middle" fill="var(--cp-muted)" font-size="11">Earth</text>
              </g>

              <g id="earth-shadow-group" style="display: none;">
                <defs>
                  <linearGradient id="shadowGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="var(--cp-bg0)" stop-opacity="0.6" />
                    <stop offset="100%" stop-color="var(--cp-bg0)" stop-opacity="0" />
                  </linearGradient>
                </defs>
                <path
                  id="umbra-cone"
                  d="M 225 200 L 380 185 L 380 215 Z"
                  fill="var(--cp-bg0)"
                  fill-opacity="0.55"
                  stroke="none"
                />
                <path
                  id="penumbra-cone"
                  d="M 225 200 L 400 160 L 400 240 Z"
                  fill="url(#shadowGradient)"
                  stroke="var(--cp-muted)"
                  stroke-opacity="0.35"
                  stroke-width="1"
                  stroke-dasharray="4 2"
                />
                <text x="320" y="155" fill="var(--cp-celestial-sun)" font-size="10" opacity="0.8">
                  Earth's Shadow
                </text>
                <text x="300" y="168" fill="var(--cp-celestial-sun)" font-size="9" opacity="0.6">
                  (only matters for eclipses)
                </text>
              </g>

              <g
                id="moon-group"
                class="moon-draggable"
                role="slider"
                aria-label="Moon position on orbit"
                aria-valuemin="0"
                aria-valuemax="360"
                aria-valuenow="0"
                aria-valuetext="Full Moon, 100% illuminated"
                tabindex="0"
              >
                <circle id="moon-dark" cx="320" cy="200" r="15" fill="var(--cp-celestial-moon-dark)" />
                <circle id="moon-lit" cx="320" cy="200" r="15" fill="url(#moonLit)" clip-path="url(#moonLitHalfClip)" />
                <line
                  id="moon-terminator"
                  x1="320"
                  y1="185"
                  x2="320"
                  y2="215"
                  stroke="var(--cp-muted)"
                  stroke-width="1"
                  opacity="0.85"
                />
              </g>

              <g id="view-indicator" opacity="0.5">
                <path d="M 200 175 L 200 140" stroke="var(--cp-celestial-earth)" stroke-width="1" stroke-dasharray="3 3" />
                <text x="200" y="130" text-anchor="middle" fill="var(--cp-celestial-earth)" font-size="9">
                  Your view
                </text>
              </g>
            </svg>
            <div class="drag-hint">Drag the Moon around Earth's orbit</div>
          </div>

          <div class="viz-panel">
            <div class="panel-title">As Seen from Earth</div>
            <svg id="phase-svg" viewBox="0 15 200 175" preserveAspectRatio="xMidYMid meet">
              <defs>
                <radialGradient id="moonSurface" cx="30%" cy="30%">
                  <stop offset="0%" stop-color="var(--cp-celestial-moon)" />
                  <stop offset="100%" stop-color="var(--cp-celestial-moon-dark)" />
                </radialGradient>

                <radialGradient id="earthshine" cx="70%" cy="30%">
                  <stop offset="0%" stop-color="var(--cp-bg2)" />
                  <stop offset="100%" stop-color="var(--cp-bg3)" />
                </radialGradient>
              </defs>

              <g transform="translate(100, 100)">
                <circle r="60" fill="url(#earthshine)" />
                <path id="lit-portion" d="" fill="url(#moonSurface)" />
              </g>

            </svg>
            <span class="waxing-waning-badge" id="waxing-waning-label">Waxing</span>
            <div class="schematic-note">Schematic (not to scale).</div>
          </div>
        </div>
      </section>

      <!-- ═══════════════════════════════════════════
           PLAYBAR — transport + timeline
           ═══════════════════════════════════════════ -->
      <div class="cp-playbar" aria-label="Animation and timeline">
        <div class="playbar-transport">
          <button class="cp-playbar__btn" id="btn-play" type="button" aria-label="Play">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M4 2l10 6-10 6z"/></svg>
          </button>
          <button class="cp-playbar__btn" id="btn-pause" type="button" aria-label="Pause" disabled>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><rect x="3" y="2" width="3.5" height="12"/><rect x="9.5" y="2" width="3.5" height="12"/></svg>
          </button>
          <button class="cp-playbar__btn" id="btn-step-back" type="button" aria-label="Step backward">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><rect x="2" y="2" width="2" height="12"/><path d="M14 2L6 8l8 6z"/></svg>
          </button>
          <button class="cp-playbar__btn" id="btn-step-forward" type="button" aria-label="Step forward">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><rect x="12" y="2" width="2" height="12"/><path d="M2 2l8 6-8 6z"/></svg>
          </button>
          <button class="cp-playbar__btn" id="btn-reset" type="button" aria-label="Reset to Full Moon" title="Reset to Full Moon">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M2 8a6 6 0 1 1 1.8 4.3"/><path d="M2 13V8h5"/></svg>
          </button>
          <label class="speed-control" for="speed-select">
            <span>Speed</span>
            <select id="speed-select" class="cp-select">
              <option value="1">1x</option>
              <option value="5" selected>5x</option>
              <option value="10">10x</option>
            </select>
          </label>
        </div>

        <div class="playbar-timeline">
          <div class="timeline-header">
            <span class="timeline-direction" id="timeline-direction">WAXING &#x2192;</span>
            <span class="timeline-day" id="timeline-day">Day 0 of 29.5</span>
          </div>
          <div class="timeline-strip" id="timeline-strip">
            <button class="timeline-phase" data-angle="180" type="button" aria-label="New Moon">
              <div class="phase-icon new-moon"></div>
              <span>New</span>
            </button>
            <button class="timeline-phase" data-angle="225" type="button" aria-label="Waxing Crescent">
              <div class="phase-icon waxing-crescent"></div>
              <span>Crescent</span>
            </button>
            <button class="timeline-phase" data-angle="270" type="button" aria-label="First Quarter">
              <div class="phase-icon first-quarter"></div>
              <span>1st Qtr</span>
            </button>
            <button class="timeline-phase" data-angle="315" type="button" aria-label="Waxing Gibbous">
              <div class="phase-icon waxing-gibbous"></div>
              <span>Gibbous</span>
            </button>
            <button class="timeline-phase" data-angle="0" type="button" aria-label="Full Moon">
              <div class="phase-icon full-moon"></div>
              <span>Full</span>
            </button>
            <button class="timeline-phase" data-angle="45" type="button" aria-label="Waning Gibbous">
              <div class="phase-icon waning-gibbous"></div>
              <span>Gibbous</span>
            </button>
            <button class="timeline-phase" data-angle="90" type="button" aria-label="Third Quarter">
              <div class="phase-icon third-quarter"></div>
              <span>3rd Qtr</span>
            </button>
            <button class="timeline-phase" data-angle="135" type="button" aria-label="Waning Crescent">
              <div class="phase-icon waning-crescent"></div>
              <span>Crescent</span>
            </button>
          </div>
          <div id="rise-set-line" class="rise-set-line is-hidden">
            <span id="rise-set-text">Rises ~6 PM · Sets ~6 AM</span>
          </div>
        </div>
      </div>

      <!-- ═══════════════════════════════════════════
           READOUT STRIP — pinned readouts
           ═══════════════════════════════════════════ -->
      <div class="cp-readout-strip cp-demo__readouts" aria-label="Readouts">
        <div class="cp-readout">
          <span class="cp-readout__label">Phase</span>
          <span class="cp-readout__value" id="phase-name">Full Moon</span>
        </div>
        <div class="cp-readout">
          <span class="cp-readout__label">Angle</span>
          <span class="cp-readout__value"><span id="angleReadout">0</span><span class="cp-readout__unit">deg</span></span>
        </div>
        <div class="cp-readout">
          <span class="cp-readout__label">Illuminated</span>
          <span class="cp-readout__value"><span id="illumination">100</span><span class="cp-readout__unit">%</span></span>
        </div>
        <div class="cp-readout">
          <span class="cp-readout__label">Days since new</span>
          <span class="cp-readout__value"><span id="days-since-new">14.8</span><span class="cp-readout__unit">d</span></span>
        </div>
      </div>

      <!-- ═══════════════════════════════════════════
           SHELF — tabbed pedagogical content
           ═══════════════════════════════════════════ -->
      <section class="cp-demo__shelf" aria-label="Information panels">
        <div class="cp-tabs-container">
          <div class="cp-tabs" role="tablist" aria-label="Demo information">
            <button class="cp-tab cp-tab--active" role="tab" aria-selected="true"
                    aria-controls="tab-notice" id="tab-btn-notice">What to notice</button>
            <button class="cp-tab" role="tab" aria-selected="false"
                    aria-controls="tab-model" id="tab-btn-model">Model notes</button>
          </div>
          <div class="cp-tab-panel" role="tabpanel" id="tab-notice" aria-labelledby="tab-btn-notice">
            <ul>
              <li><strong>Observable:</strong> the lit fraction grows or shrinks as the Moon moves.</li>
              <li><strong>Model:</strong> illumination depends on the Sun-Earth-Moon phase angle $\alpha$.</li>
              <li><strong>Inference:</strong> phases are geometry, not Earth's shadow.</li>
            </ul>
          </div>
          <div class="cp-tab-panel" role="tabpanel" id="tab-model" aria-labelledby="tab-btn-model" hidden>
            <ul>
              <li>Schematic geometry (not to scale, no orbital tilt).</li>
              <li>Illumination uses $f = \frac{1 + \cos\alpha}{2}$ with $\alpha$ in degrees.</li>
              <li>Earth's shadow appears only when toggled and only for eclipse insight.</li>
            </ul>
          </div>
        </div>
      </section>
    </div>

    <script type="module" src="./main.ts"></script>
  </body>
</html>
