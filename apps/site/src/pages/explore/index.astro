---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import DemoCard from "../../components/DemoCard.astro";
import FilterBar from "../../components/FilterBar.astro";
import EmptyState from "../../components/EmptyState.astro";
import TopicIcon from "../../components/TopicIcon.astro";

const demos = await getCollection("demos");
const base = import.meta.env.BASE_URL;
const exploreHref = `${base}explore/`;

const q = Astro.url.searchParams.get("q")?.trim() ?? "";
const topic = Astro.url.searchParams.get("topic")?.trim() ?? "";
const level = Astro.url.searchParams.get("level")?.trim() ?? "";
const time = Astro.url.searchParams.get("time")?.trim() ?? "";
const status = Astro.url.searchParams.get("status")?.trim() ?? "";
const math = Astro.url.searchParams.get("math")?.trim() ?? "";
const sort = Astro.url.searchParams.get("sort")?.trim() || "recommended";

const topics = Array.from(
  new Set(demos.flatMap((d) => d.data.topics))
).sort();
const levels = Array.from(
  new Set(demos.flatMap((d) => d.data.levels))
).sort();
const statuses = Array.from(new Set(demos.map((d) => d.data.status))).sort();
const topicOrder = [
  "EarthSky",
  "Orbits",
  "LightSpectra",
  "Telescopes",
  "DataInference",
  "Stars",
  "Galaxies",
  "Cosmology"
];
const topicLabel: Record<string, string> = {
  EarthSky: "Earth & Sky",
  Orbits: "Orbits",
  LightSpectra: "Light & Spectra",
  Telescopes: "Telescopes",
  DataInference: "Data & Inference",
  Stars: "Stars",
  Galaxies: "Galaxies",
  Cosmology: "Cosmology"
};
const featuredOrder = ["keplers-laws", "retrograde-motion", "binary-orbits"];
const featured = demos
  .filter((d) => d.data.featured)
  .sort(
    (a, b) =>
      featuredOrder.indexOf(a.slug) - featuredOrder.indexOf(b.slug) ||
      a.data.title.localeCompare(b.data.title)
  );

function excerptFromBody(body: string) {
  const firstLine = body
    .split("\n")
    .map((l) => l.trim())
    .find((l) => l.length > 0 && !l.startsWith("---"));
  if (!firstLine) return "—";
  return firstLine.replace(/^#+\s*/, "").slice(0, 140);
}

function timeBucket(minutes: number) {
  if (minutes <= 10) return "lt10";
  if (minutes <= 20) return "10to20";
  return "gt20";
}

const filtered = demos
  .filter((d) => {
    const hay = `${d.data.title} ${d.data.tags.join(" ")}`
      .toLowerCase()
      .trim();
    const needle = q.toLowerCase().trim();
    return needle.length === 0 ? true : hay.includes(needle);
  })
  .filter((d) => (topic ? d.data.topics.includes(topic as any) : true))
  .filter((d) => (level ? d.data.levels.includes(level as any) : true))
  .filter((d) => (status ? d.data.status === status : true))
  .filter((d) => (math ? d.data.has_math_mode === (math === "yes") : true))
  .filter((d) => (time ? timeBucket(d.data.time_minutes) === time : true));

function parseIsoDate(iso: string) {
  const t = Date.parse(iso);
  return Number.isNaN(t) ? 0 : t;
}

const statusRank: Record<string, number> = { stable: 0, beta: 1, draft: 2 };

const sorted = [...filtered].sort((a, b) => {
  if (sort === "shortest") return a.data.time_minutes - b.data.time_minutes;
  if (sort === "newest")
    return parseIsoDate(b.data.last_updated) - parseIsoDate(a.data.last_updated);
  // recommended: stable > beta > draft, then newest, then title
  return (
    (statusRank[a.data.status] ?? 99) - (statusRank[b.data.status] ?? 99) ||
    parseIsoDate(b.data.last_updated) - parseIsoDate(a.data.last_updated) ||
    a.data.title.localeCompare(b.data.title)
  );
});

const params = Astro.url.searchParams;
const buildHref = (next: URLSearchParams) => {
  const qs = next.toString();
  return qs ? `${exploreHref}?${qs}` : exploreHref;
};
const chips: { label: string; href: string }[] = [];
const addChip = (key: string, label: string) => {
  const next = new URLSearchParams(params);
  next.delete(key);
  chips.push({ label, href: buildHref(next) });
};
const timeLabels: Record<string, string> = {
  lt10: "≤10 min",
  "10to20": "10–20 min",
  gt20: "20+ min"
};
const sortLabels: Record<string, string> = {
  recommended: "Recommended",
  shortest: "Shortest",
  newest: "Newest"
};

if (q) addChip("q", `Search: ${q}`);
if (topic) addChip("topic", `Topic: ${topic}`);
if (level) addChip("level", `Course level: ${level}`);
if (time) addChip("time", `Time budget: ${timeLabels[time] ?? time}`);
if (status) addChip("status", `Status: ${status}`);
if (math) addChip("math", `Math required: ${math === "yes" ? "Yes" : "No"}`);
if (sort && sort !== "recommended") addChip("sort", `Sort: ${sortLabels[sort] ?? sort}`);

const topicDescription: Record<string, string> = {
  EarthSky: "Moon phases, seasons, and the view from Earth.",
  Orbits: "Kepler's laws, retrograde motion, and gravitational dynamics.",
  LightSpectra: "Blackbody radiation, electromagnetic spectrum, and spectral analysis.",
  Telescopes: "Resolution, diffraction, and optical design.",
  DataInference: "Statistics, measurement, and scientific reasoning.",
  Stars: "Stellar structure, evolution, and equations of state.",
  Galaxies: "Galaxy types, rotation, and large-scale structure.",
  Cosmology: "Expansion, dark energy, and the cosmic microwave background."
};

const allSlugs = demos.map((d) => d.slug);
const randomSlug = allSlugs[Math.floor(Math.random() * allSlugs.length)];

const noFilters = chips.length === 0;
const showFeatured = noFilters && featured.length > 0;
const featuredSlugs = new Set(featured.map((d) => d.slug));
const topicSections = noFilters
  ? topicOrder
      .map((key) => ({
        key,
        label: topicLabel[key],
        demos: sorted.filter(
          (d) =>
            d.data.topics.includes(key as any) && !featuredSlugs.has(d.slug)
        )
      }))
      .filter((section) => section.demos.length > 0)
  : [];
---

<Layout title="Explore — Cosmic Playground" hasMath={false}>
  <section class="explore-hero cp-hero">
    <h1>Explore</h1>
    <p class="explore-hero__tagline">Play with the universe. Learn the physics.</p>
    <p class="lede">Interactive exhibits for seeing how astronomy actually works.</p>
  </section>

  <FilterBar
    query={q}
    topic={topic}
    level={level}
    time={time}
    status={status}
    math={math}
    sort={sort}
    topics={topics}
    levels={levels}
    statuses={statuses}
  />

  {chips.length > 0 ? (
    <div class="filter-chips" aria-label="Active filters">
      {chips.map((chip) => (
        <a class="cp-chip" href={chip.href}>
          {chip.label} <span aria-hidden="true">×</span>
        </a>
      ))}
      <a class="cp-chip cp-chip--clear" href={exploreHref}>Clear all</a>
    </div>
  ) : null}

  {showFeatured && featured.length > 0 ? (
    <section class="featured" aria-label="Start here: Gravity and Orbits">
      <div class="featured__header">
        <h2>Start here: Gravity &amp; Orbits</h2>
        <p class="featured__lede">Begin with the core orbit ideas before branching out.</p>
      </div>
      <div class="results__grid">
        {featured.map((d) => (
          <DemoCard
            title={d.data.title}
            slug={d.slug}
            href={`${base}exhibits/${d.slug}/`}
            description={excerptFromBody(d.body)}
            status={d.data.status}
            topics={d.data.topics}
            levels={d.data.levels}
            timeMinutes={d.data.time_minutes}
            hasMathMode={d.data.has_math_mode}
          />
        ))}
      </div>
    </section>
  ) : null}

  {noFilters ? (
    <div class="explore-onboard">
      <ul class="explore-onboard__cadence" aria-label="Predict, Play, Explain">
        <li>Predict</li>
        <li>Play</li>
        <li>Explain</li>
      </ul>
      <p class="explore-onboard__lede">A simple loop for every exhibit.</p>
    </div>
  ) : null}

  <div class="results__count">
    <span class="results__count-value">{sorted.length}</span>
    <span class="results__count-unit">interactive exhibit{sorted.length === 1 ? "" : "s"}</span>
    <a
      class="cp-button cp-button--ghost results__surprise"
      href={`${base}exhibits/${randomSlug}/`}
      data-all-slugs={JSON.stringify(allSlugs)}
    >
      Surprise me
    </a>
  </div>

  {noFilters ? (
    <nav class="topic-index" aria-label="Jump to topic">
      {topicSections.map((section) => (
        <a
          class="cp-chip topic-index__link"
          href={`#topic-${section.key.toLowerCase()}`}
        >
          {section.label}
        </a>
      ))}
    </nav>
  ) : null}

  <section class="results" aria-label="Demo results">
    {noFilters ? (
      <div class="cp-section">
        {topicSections.map((section) => (
          <div
            class="topic-section"
            id={`topic-${section.key.toLowerCase()}`}
          >
            <div class="topic-section__header">
              <TopicIcon topic={section.key} size={28} />
              <div>
                <h2 class="topic-section__title">{section.label}</h2>
                {topicDescription[section.key] && (
                  <p class="topic-section__desc">{topicDescription[section.key]}</p>
                )}
              </div>
            </div>
            <div class="results__grid">
              {section.demos.map((d) => (
                <DemoCard
                  title={d.data.title}
                  slug={d.slug}
                  href={`${import.meta.env.BASE_URL}exhibits/${d.slug}/`}
                  description={excerptFromBody(d.body)}
                  status={d.data.status}
                  topics={d.data.topics}
                  levels={d.data.levels}
                  timeMinutes={d.data.time_minutes}
                  hasMathMode={d.data.has_math_mode}
                />
              ))}
            </div>
          </div>
        ))}
      </div>
    ) : (
      <>
        {sorted.length > 0 ? (
          <div class="results__grid">
            {sorted.map((d) => (
              <DemoCard
                title={d.data.title}
                slug={d.slug}
                href={`${import.meta.env.BASE_URL}exhibits/${d.slug}/`}
                description={excerptFromBody(d.body)}
                status={d.data.status}
                topics={d.data.topics}
                levels={d.data.levels}
                timeMinutes={d.data.time_minutes}
                hasMathMode={d.data.has_math_mode}
              />
            ))}
          </div>
        ) : (
          <EmptyState />
        )}
      </>
    )}
  </section>
</Layout>

<script>
  const form = document.querySelector("[data-filter-form]");
  if (form instanceof HTMLFormElement) {
    form.classList.add("is-enhanced");
    const search = form.querySelector("input[name='q']");
    const selects = form.querySelectorAll("select");
    let timer: ReturnType<typeof setTimeout> | undefined;
    const submit = () => (form.requestSubmit ? form.requestSubmit() : form.submit());

    if (search) {
      search.addEventListener("input", () => {
        clearTimeout(timer);
        timer = setTimeout(submit, 300);
      });
    }

    selects.forEach((select) => {
      select.addEventListener("change", submit);
    });
  }

  const surpriseBtn = document.querySelector("[data-all-slugs]");
  if (surpriseBtn instanceof HTMLAnchorElement) {
    const slugs = JSON.parse(surpriseBtn.dataset.allSlugs || "[]");
    surpriseBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const slug = slugs[Math.floor(Math.random() * slugs.length)];
      const base = document.querySelector("base")?.href || "/";
      window.location.href = `${base}exhibits/${slug}/`;
    });
  }
</script>

<style>
  .explore-hero {
    margin-bottom: var(--cp-space-5);
  }

  .lede {
    margin: 6px 0 0;
    color: var(--cp-muted);
    max-width: 72ch;
  }

  .explore-hero__tagline {
    margin: 10px 0 0;
    font-size: var(--cp-text-xl);
    font-weight: var(--cp-font-semibold);
    color: var(--cp-title-strong);
    max-width: 60ch;
  }

  .filter-chips {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .featured {
    margin-top: var(--cp-space-6);
  }

  .featured__header {
    margin-bottom: 10px;
    display: grid;
    gap: var(--cp-space-1);
  }

  .featured h2 {
    margin: 0;
  }

  .featured__lede {
    margin: 0;
    color: var(--cp-text2);
    max-width: 72ch;
  }

  .explore-onboard {
    margin-top: var(--cp-space-6);
    display: grid;
    gap: var(--cp-space-1);
  }

  .explore-onboard__cadence {
    margin: 0;
    padding: 0;
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    gap: var(--cp-space-2);
    font-size: var(--cp-text-lg);
  }

  .explore-onboard__cadence li {
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid var(--cp-border-subtle);
    background: var(--cp-chip-bg);
    color: var(--cp-title-strong);
    font-weight: var(--cp-font-semibold);
    letter-spacing: 0.02em;
  }

  .explore-onboard__lede {
    margin: 0;
    color: var(--cp-text2);
    max-width: 72ch;
  }

  .results {
    margin-top: var(--cp-space-6);
  }

  .results__count {
    margin-top: var(--cp-space-5);
    display: flex;
    align-items: baseline;
    gap: var(--cp-space-2);
    flex-wrap: wrap;
  }

  .results__count-value {
    font-family: var(--cp-font-mono);
    font-size: var(--cp-text-2xl);
    font-weight: var(--cp-font-semibold);
    color: var(--cp-accent-amber);
    line-height: 1;
  }

  .results__count-unit {
    color: var(--cp-accent-ice);
    font-size: var(--cp-text-sm);
  }

  .results__surprise {
    margin-left: auto;
    font-size: var(--cp-text-sm);
  }

  .results__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--cp-space-6);
  }

  .topic-index {
    margin-top: var(--cp-space-5);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .topic-section {
    margin-top: var(--cp-space-6);
  }

  .topic-section__header {
    display: flex;
    align-items: flex-start;
    gap: var(--cp-space-3);
    margin-bottom: var(--cp-space-4);
    scroll-margin-top: calc(var(--cp-space-7) + 48px);
    color: var(--cp-muted);
  }

  .topic-section__title {
    margin: 0;
  }

  .topic-section__desc {
    margin: var(--cp-space-1) 0 0;
    font-size: var(--cp-text-sm);
    color: var(--cp-text2);
    max-width: 60ch;
  }
</style>
