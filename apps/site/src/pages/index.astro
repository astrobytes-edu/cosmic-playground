---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";
import MiniCard from "../components/MiniCard.astro";
import NebularHero from "../components/NebularHero.astro";
import PPEVisual from "../components/PPEVisual.astro";
import Icon from "../components/Icon.astro";
import TopicStrip from "../components/TopicStrip.astro";
import DemoIllustration from "../components/DemoIllustration.astro";
import { topicColor, primaryTopic } from "../lib/topicColors";

const demos = await getCollection("demos");

function parseIsoDate(iso: string) {
  const t = Date.parse(iso);
  return Number.isNaN(t) ? 0 : t;
}

/* Featured demos — curated starter sequence */
const featuredOrder = ["keplers-laws", "retrograde-motion", "binary-orbits"];
const featured = demos
  .filter((d) => d.data.featured)
  .sort(
    (a, b) =>
      featuredOrder.indexOf(a.slug) - featuredOrder.indexOf(b.slug) ||
      a.data.title.localeCompare(b.data.title)
  );

/* Recent demos — by last update */
const updated = [...demos]
  .sort((a, b) => parseIsoDate(b.data.last_updated) - parseIsoDate(a.data.last_updated))
  .slice(0, 8);

function excerptFromBody(body: string) {
  const firstLine = body
    .split("\n")
    .map((l) => l.trim())
    .find((l) => l.length > 0 && !l.startsWith("---"));
  if (!firstLine) return "\u2014";
  return firstLine.replace(/^#+\s*/, "").slice(0, 140);
}

const base = import.meta.env.BASE_URL;
---

<Layout title="Cosmic Playground" hasMath={false}>

  {/* ───── Observatory Hero ───── */}
  <section class="obs-hero cp-hero" aria-label="Welcome">
    <NebularHero />
    <div class="obs-hero__content">
      <h1 class="obs-hero__title">Cosmic Playground</h1>
      <p class="obs-hero__tagline">Play with the universe. Learn the physics.</p>
      <div class="obs-hero__actions">
        <a class="cp-button cp-button--primary" href={`${base}explore/`}>
          Explore demos
        </a>
        <a class="cp-button cp-button--ghost" href={`${base}playlists/`}>
          Browse playlists
        </a>
      </div>
    </div>
  </section>

  {/* ───── Topic Discovery Strip ───── */}
  <TopicStrip baseUrl={base} />

  {/* ───── How It Works: PPE Cadence ───── */}
  <section class="home-section" aria-label="How it works">
    <h2 class="home-section__heading">How it works</h2>
    <p class="home-section__lead">
      Every demo follows the same three-phase cadence. Commit to a prediction,
      explore the model, then reconcile what happened.
    </p>
    <PPEVisual />
  </section>

  {/* ───── Start Here: Featured Demos ───── */}
  <section class="home-section" aria-label="Start here">
    <h2 class="home-section__heading">Start here</h2>
    <p class="home-section__lead">
      These three demos introduce the core orbital mechanics concepts.
      Work through them in order for the best experience.
    </p>
    <div class="featured-grid">
      {featured.map((d, i) => {
        const topic = primaryTopic(d.data.topics);
        const color = topicColor(topic);
        return (
          <article class="featured-card cp-card" style={`--card-i: ${i}; --topic-color: ${color}`}>
            <a class="featured-card__link" href={`${base}exhibits/${d.slug}/`}>
              <div class="featured-card__illustration">
                <DemoIllustration slug={d.slug} />
              </div>
              <div class="featured-card__body">
                <span class="featured-card__number">{i + 1}</span>
                <h3 class="featured-card__title">{d.data.title}</h3>
                <p class="featured-card__desc">{excerptFromBody(d.body)}</p>
              </div>
            </a>
          </article>
        );
      })}
    </div>
  </section>

  {/* ───── Recent Demos ───── */}
  <section class="home-section" aria-label="Recently updated demos">
    <h2 class="home-section__heading">Recently updated</h2>
    <div class="recent-scroll">
      {updated.map((d) => (
        <MiniCard
          title={d.data.title}
          slug={d.slug}
          href={`${base}exhibits/${d.slug}/`}
          topics={d.data.topics}
          lastUpdated={d.data.last_updated}
        />
      ))}
    </div>
  </section>

  {/* ───── Scroll-triggered entrance animations ───── */}
  <script>
    if (!window.matchMedia("(prefers-reduced-motion: reduce)").matches) {
      const sections = document.querySelectorAll(".home-section");
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("is-visible");
              observer.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.15 }
      );
      sections.forEach((s) => observer.observe(s));
    }
  </script>

  {/* ───── For Instructors ───── */}
  <section class="home-section instructor-entry" aria-label="For instructors">
    <h2 class="home-section__heading">For instructors</h2>
    <p class="home-section__lead">
      Station cards, instructor notes, and curated playlists for classroom use.
    </p>
    <div class="instructor-links">
      <a class="instructor-link" href={`${base}stations/`}>
        <Icon name="BookOpen" size={20} />
        <span>Station Cards</span>
      </a>
      <a class="instructor-link" href={`${base}instructor/`}>
        <Icon name="GraduationCap" size={20} />
        <span>Instructor Notes</span>
      </a>
      <a class="instructor-link" href={`${base}playlists/`}>
        <Icon name="Shuffle" size={20} />
        <span>Playlists</span>
      </a>
    </div>
  </section>

</Layout>

<style>
  /* ── Observatory Hero ─────────────────────── */
  .obs-hero {
    position: relative;
    min-height: var(--cp-hero-min-height);
    display: flex;
    align-items: center;
    overflow: hidden;
  }

  /* Vignette overlay */
  .obs-hero::before {
    content: "";
    position: absolute;
    inset: 0;
    background:
      radial-gradient(
        ellipse 100% 100% at 50% 50%,
        transparent 40%,
        color-mix(in srgb, var(--cp-bg0) 50%, transparent) 100%
      );
    pointer-events: none;
    z-index: 0;
  }

  .obs-hero__content {
    position: relative;
    z-index: 1;
    display: grid;
    gap: var(--cp-space-3);
    max-width: 36rem;
  }

  .obs-hero__title {
    margin: 0;
    font-size: var(--cp-text-hero);
    font-weight: var(--cp-font-bold);
    line-height: 1.1;
    letter-spacing: -0.03em;
    color: var(--cp-title-strong);
    text-shadow:
      0 0 60px color-mix(in srgb, var(--cp-accent) 15%, transparent),
      0 0 120px color-mix(in srgb, var(--cp-accent) 8%, transparent);
  }

  .obs-hero__tagline {
    margin: 0;
    font-size: var(--cp-text-lg);
    color: var(--cp-text2);
    letter-spacing: 0.01em;
  }

  .obs-hero__actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--cp-space-3);
    margin-top: var(--cp-space-2);
  }

  @media (max-width: 767px) {
    .obs-hero {
      min-height: 40vh;
    }
    .obs-hero__title {
      font-size: var(--cp-text-3xl);
    }
  }

  /* ── Sections ─────────────────────────────── */
  .home-section {
    margin-top: var(--cp-space-7);
    opacity: 0;
    transform: translateY(16px);
    transition:
      opacity 0.5s var(--cp-ease-out),
      transform 0.5s var(--cp-ease-out);
  }

  .home-section.is-visible {
    opacity: 1;
    transform: translateY(0);
  }

  @media (prefers-reduced-motion: reduce) {
    .home-section {
      opacity: 1;
      transform: none;
      transition: none;
    }
  }

  .home-section__heading {
    margin: 0 0 var(--cp-space-2);
  }

  .home-section__lead {
    margin: 0 0 var(--cp-space-5);
    color: var(--cp-text2);
    max-width: 60ch;
  }

  /* ── Featured Grid (asymmetric) ────────────── */
  .featured-grid {
    display: grid;
    grid-template-columns: 1.2fr 0.8fr;
    grid-template-rows: 1fr 1fr;
    gap: var(--cp-space-5);
  }

  .featured-card:first-child {
    grid-row: 1 / -1;
  }

  @media (max-width: 767px) {
    .featured-grid {
      grid-template-columns: 1fr;
      grid-template-rows: auto;
    }
    .featured-card:first-child {
      grid-row: auto;
    }
  }

  .featured-card {
    position: relative;
    overflow: clip;
    animation: cp-slide-up 0.5s var(--cp-ease-out) both;
    animation-delay: calc(var(--card-i, 0) * 0.1s + 0.2s);
    transition:
      transform 200ms var(--cp-ease-out),
      border-color 200ms var(--cp-ease-out),
      box-shadow 200ms var(--cp-ease-out);
  }

  /* Accent stripe along top edge */
  .featured-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(
      90deg,
      color-mix(in srgb, var(--topic-color) 60%, transparent),
      color-mix(in srgb, var(--cp-violet) 40%, transparent)
    );
    opacity: 0.5;
    transition: opacity 200ms var(--cp-ease-out);
  }

  .featured-card:hover::before {
    opacity: 1;
  }

  .featured-card:hover {
    transform: translateY(-4px);
    border-color: color-mix(in srgb, var(--topic-color) 40%, transparent);
    box-shadow:
      var(--cp-card-shadow-hover),
      0 0 20px color-mix(in srgb, var(--topic-color) 10%, transparent);
  }

  @media (prefers-reduced-motion: reduce) {
    .featured-card {
      animation: none;
      transition: none;
    }
    .featured-card:hover {
      transform: none;
    }
  }

  .featured-card__link {
    display: flex;
    flex-direction: column;
    height: 100%;
    text-decoration: none;
  }

  .featured-card__illustration {
    padding: var(--cp-space-4);
    background:
      radial-gradient(
        ellipse 80% 70% at 50% 50%,
        color-mix(in srgb, var(--topic-color) 8%, transparent) 0%,
        transparent 70%
      );
    border-bottom: 1px solid var(--cp-border-subtle);
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .featured-card__body {
    padding: var(--cp-space-4);
    position: relative;
  }

  .featured-card__number {
    position: absolute;
    top: var(--cp-space-3);
    right: var(--cp-space-3);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: color-mix(in srgb, var(--topic-color) 15%, transparent);
    border: 1px solid color-mix(in srgb, var(--topic-color) 30%, transparent);
    color: var(--topic-color);
    font-family: var(--cp-font-display);
    font-size: var(--cp-text-sm);
    font-weight: var(--cp-font-semibold);
  }

  .featured-card__title {
    margin: 0;
    font-size: var(--cp-text-xl);
    color: var(--cp-title);
  }

  .featured-card:hover .featured-card__title {
    color: var(--cp-title-strong);
  }

  .featured-card__desc {
    margin: var(--cp-space-2) 0 0;
    color: var(--cp-text2);
    font-size: var(--cp-text-sm);
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* ── Recent Scroll ────────────────────────── */
  .recent-scroll {
    display: flex;
    gap: var(--cp-space-4);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    padding-bottom: var(--cp-space-2);
  }

  .recent-scroll > :global(*) {
    scroll-snap-align: start;
  }

  /* Hide scrollbar on webkit / firefox */
  .recent-scroll::-webkit-scrollbar {
    height: 4px;
  }
  .recent-scroll::-webkit-scrollbar-track {
    background: transparent;
  }
  .recent-scroll::-webkit-scrollbar-thumb {
    background: var(--cp-border);
    border-radius: 2px;
  }

  /* ── Instructor Entry ─────────────────────── */
  .instructor-entry {
    padding: var(--cp-space-5);
    border: 1px solid var(--cp-border-subtle);
    border-radius: var(--cp-r-3);
    background: color-mix(in srgb, var(--cp-bg1) 50%, transparent);
  }

  .instructor-links {
    display: flex;
    flex-wrap: wrap;
    gap: var(--cp-space-4);
  }

  .instructor-link {
    display: flex;
    align-items: center;
    gap: var(--cp-space-2);
    padding: var(--cp-space-3) var(--cp-space-4);
    border-radius: var(--cp-r-2);
    border: 1px solid var(--cp-border);
    background: color-mix(in srgb, var(--cp-bg2) 50%, transparent);
    color: var(--cp-text2);
    text-decoration: none;
    font-weight: var(--cp-font-medium);
    transition:
      border-color var(--cp-transition-fast) var(--cp-ease-out),
      color var(--cp-transition-fast) var(--cp-ease-out),
      background var(--cp-transition-fast) var(--cp-ease-out);
  }

  .instructor-link:hover {
    border-color: var(--cp-accent);
    color: var(--cp-text);
    background: color-mix(in srgb, var(--cp-accent) 6%, transparent);
  }
</style>
