---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import DemoCard from "../../components/DemoCard.astro";
import TopicIcon from "../../components/TopicIcon.astro";

const topicOrder = [
  "EarthSky",
  "Orbits",
  "LightSpectra",
  "Telescopes",
  "DataInference",
  "Stars",
  "Galaxies",
  "Cosmology"
];

const topicLabel: Record<string, string> = {
  EarthSky: "Earth & Sky",
  Orbits: "Orbits",
  LightSpectra: "Light & Spectra",
  Telescopes: "Telescopes",
  DataInference: "Data & Inference",
  Stars: "Stars",
  Galaxies: "Galaxies",
  Cosmology: "Cosmology"
};

const topicDescription: Record<string, string> = {
  EarthSky: "Moon phases, seasons, eclipses, and the geometry of what we see from Earth. These demos build intuition for how angles, distances, and illumination combine to produce the sky we observe.",
  Orbits: "Kepler\u2019s laws, retrograde motion, binary systems, and gravitational dynamics. Interactive simulations that reveal how orbits shape planetary motion and timing.",
  LightSpectra: "Blackbody radiation, the electromagnetic spectrum, and spectral analysis. Explore how temperature, wavelength, and energy are connected through the physics of light.",
  Telescopes: "Resolution, diffraction, and what limits how much detail a telescope can see. Understand the relationship between aperture, wavelength, and angular resolution.",
  DataInference: "Statistical reasoning, measurement uncertainty, and the connection between data and physical models. Learn how astronomers extract meaning from observations.",
  Stars: "Stellar structure, equations of state, and the internal physics that determine how stars work. Explore the relationship between temperature, pressure, and density inside stars.",
  Galaxies: "Galaxy morphology, rotation curves, and large-scale structure. Investigate how galaxies are organized and what their dynamics reveal about dark matter.",
  Cosmology: "The expanding universe, dark energy, and the cosmic microwave background. Explore the observations and models that describe the universe on the largest scales."
};

const suggestedOrder: Record<string, string[]> = {
  EarthSky: ["moon-phases", "eclipse-geometry", "seasons", "angular-size"],
  Orbits: ["keplers-laws", "retrograde-motion", "binary-orbits", "planetary-conjunctions"],
  LightSpectra: ["em-spectrum", "blackbody-radiation"],
  Telescopes: ["telescope-resolution"],
  DataInference: [],
  Stars: ["eos-lab"],
  Galaxies: [],
  Cosmology: []
};

export async function getStaticPaths() {
  const demos = await getCollection("demos");
  const topicKeys = [
    "EarthSky", "Orbits", "LightSpectra", "Telescopes",
    "DataInference", "Stars", "Galaxies", "Cosmology"
  ];

  return topicKeys
    .filter((key) =>
      demos.some((d) => d.data.topics.includes(key as any))
    )
    .map((key) => ({
      params: { slug: key.toLowerCase() },
      props: { topicKey: key }
    }));
}

const { topicKey } = Astro.props;
const base = import.meta.env.BASE_URL;
const withBase = (path: string) => {
  const normalizedBase = base.endsWith("/") ? base : `${base}/`;
  const normalizedPath = path.startsWith("/") ? path.slice(1) : path;
  return `${normalizedBase}${normalizedPath}`;
};

const demos = await getCollection("demos");
const playlists = await getCollection("playlists");

const topicDemos = demos.filter((d) =>
  d.data.topics.includes(topicKey as any)
);

// Sort by suggested order, then alphabetically
const order = suggestedOrder[topicKey] ?? [];
const sorted = [...topicDemos].sort((a, b) => {
  const ai = order.indexOf(a.slug);
  const bi = order.indexOf(b.slug);
  if (ai >= 0 && bi >= 0) return ai - bi;
  if (ai >= 0) return -1;
  if (bi >= 0) return 1;
  return a.data.title.localeCompare(b.data.title);
});

function excerptFromBody(body: string) {
  const firstLine = body
    .split("\n")
    .map((l) => l.trim())
    .find((l) => l.length > 0 && !l.startsWith("---"));
  if (!firstLine) return "\u2014";
  return firstLine.replace(/^#+\s*/, "").slice(0, 140);
}

// Aggregate learning goals across demos in this topic
const allGoals = Array.from(
  new Set(topicDemos.flatMap((d) => d.data.learning_goals))
);

// Find playlists that include demos from this topic
const relatedPlaylists = playlists.filter((p) =>
  p.data.demos.some((pd) =>
    topicDemos.some((d) => d.slug === pd.slug)
  )
);

const label = topicLabel[topicKey];
const description = topicDescription[topicKey];
---

<Layout title={`${label} — Topics — Cosmic Playground`}>
  <Breadcrumb
    crumbs={[
      { label: "Topics", href: withBase("topics/") },
      { label: label }
    ]}
    withBase={withBase}
  />

  <header class="topic-hero cp-hero">
    <div class="topic-hero__icon">
      <TopicIcon topic={topicKey} size={40} />
    </div>
    <div class="topic-hero__text">
      <h1>{label}</h1>
      <p class="topic-hero__desc">{description}</p>
      <div class="topic-hero__stats">
        <span class="topic-hero__stat">
          <span class="topic-hero__stat-value">{sorted.length}</span>
          <span class="topic-hero__stat-unit">
            exhibit{sorted.length === 1 ? "" : "s"}
          </span>
        </span>
      </div>
    </div>
  </header>

  {order.length > 0 && (
    <section class="topic-order" aria-label="Suggested order">
      <h2>Suggested sequence</h2>
      <p class="topic-order__note">
        Not mandatory, but this order builds concepts incrementally.
      </p>
      <ol class="topic-order__list">
        {order
          .map((slug) => sorted.find((d) => d.slug === slug))
          .filter(Boolean)
          .map((d) => (
            <li>
              <a href={withBase(`exhibits/${d!.slug}/`)}>{d!.data.title}</a>
              <span class="topic-order__time">{d!.data.time_minutes} min</span>
            </li>
          ))}
      </ol>
    </section>
  )}

  <section class="topic-demos" aria-label="Exhibits">
    <h2>Exhibits</h2>
    <div class="topic-demos__grid">
      {sorted.map((d) => (
        <DemoCard
          title={d.data.title}
          slug={d.slug}
          href={withBase(`exhibits/${d.slug}/`)}
          description={excerptFromBody(d.body)}
          status={d.data.status}
          topics={d.data.topics}
          levels={d.data.levels}
          timeMinutes={d.data.time_minutes}
          hasMathMode={d.data.has_math_mode}
        />
      ))}
    </div>
  </section>

  {allGoals.length > 0 && (
    <details class="collapsible">
      <summary class="collapsible__trigger">
        <h2 class="collapsible__heading">Key concepts</h2>
      </summary>
      <div class="collapsible__body">
        <p class="collapsible__note">
          Learning goals aggregated from all exhibits in this topic.
        </p>
        <ul class="collapsible__list">
          {allGoals.map((g) => (
            <li>{g}</li>
          ))}
        </ul>
      </div>
    </details>
  )}

  {relatedPlaylists.length > 0 && (
    <section class="topic-playlists">
      <h2>Related playlists</h2>
      <div class="topic-playlists__grid">
        {relatedPlaylists.map((p) => (
          <a class="topic-playlist-card cp-card" href={withBase(`playlists/${p.slug}/`)}>
            <h3>{p.data.title}</h3>
            <p class="topic-playlist-card__meta">
              {p.data.audience} · ~{p.data.estimated_minutes} min
            </p>
          </a>
        ))}
      </div>
    </section>
  )}
</Layout>

<style>
  .topic-hero {
    display: flex;
    gap: var(--cp-space-5);
    align-items: flex-start;
    margin-bottom: var(--cp-space-5);
  }

  .topic-hero__icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 72px;
    height: 72px;
    border-radius: var(--cp-r-3);
    background: color-mix(in srgb, var(--cp-accent) 8%, transparent);
    color: var(--cp-accent);
    flex-shrink: 0;
  }

  .topic-hero__text {
    display: grid;
    gap: var(--cp-space-2);
  }

  .topic-hero h1 {
    margin: 0;
    font-size: 1.9rem;
  }

  .topic-hero__desc {
    margin: 0;
    color: var(--cp-text2);
    max-width: 72ch;
    line-height: 1.5;
  }

  .topic-hero__stats {
    display: flex;
    gap: var(--cp-space-3);
  }

  .topic-hero__stat {
    display: inline-flex;
    align-items: baseline;
    gap: 4px;
  }

  .topic-hero__stat-value {
    font-family: var(--cp-font-mono);
    font-size: var(--cp-text-xl);
    font-weight: var(--cp-font-semibold);
    color: var(--cp-accent-amber);
  }

  .topic-hero__stat-unit {
    font-size: var(--cp-text-sm);
    color: var(--cp-accent-ice);
  }

  .topic-order {
    margin-bottom: var(--cp-space-5);
    padding: var(--cp-space-4);
    border-radius: var(--cp-r-2);
    border: 1px solid var(--cp-border);
    background: var(--cp-bg1);
  }

  .topic-order h2 {
    margin: 0 0 var(--cp-space-1);
    font-size: var(--cp-text-lg);
  }

  .topic-order__note {
    margin: 0 0 var(--cp-space-3);
    font-size: var(--cp-text-sm);
    color: var(--cp-muted);
  }

  .topic-order__list {
    margin: 0;
    padding-left: 20px;
    line-height: 1.8;
  }

  .topic-order__list a {
    color: var(--cp-text);
    text-decoration: none;
    font-weight: var(--cp-font-medium);
  }

  .topic-order__list a:hover {
    color: var(--cp-accent);
  }

  .topic-order__time {
    font-family: var(--cp-font-mono);
    font-size: 0.75rem;
    color: var(--cp-muted);
    margin-left: var(--cp-space-2);
  }

  .topic-demos h2 {
    margin: 0 0 var(--cp-space-4);
  }

  .topic-demos__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--cp-space-6);
  }

  /* Collapsible section */
  .collapsible {
    margin-top: var(--cp-space-5);
    border: 1px solid var(--cp-border);
    border-radius: var(--cp-r-2);
    overflow: hidden;
  }

  .collapsible__trigger {
    display: flex;
    align-items: center;
    gap: var(--cp-space-2);
    padding: var(--cp-space-3) var(--cp-space-4);
    cursor: pointer;
    list-style: none;
    transition: background var(--cp-transition-fast) var(--cp-ease-out);
  }

  .collapsible__trigger::-webkit-details-marker {
    display: none;
  }

  .collapsible__trigger::before {
    content: "\25B6";
    font-size: 0.65em;
    color: var(--cp-muted);
    transition: transform var(--cp-transition-fast) var(--cp-ease-out);
  }

  .collapsible[open] > .collapsible__trigger::before {
    transform: rotate(90deg);
  }

  .collapsible__trigger:hover {
    background: color-mix(in srgb, var(--cp-text) 4%, transparent);
  }

  .collapsible__heading {
    margin: 0;
    font-size: var(--cp-text-lg);
  }

  .collapsible__body {
    padding: 0 var(--cp-space-4) var(--cp-space-4);
  }

  .collapsible__note {
    margin: 0 0 var(--cp-space-2);
    font-size: var(--cp-text-sm);
    color: var(--cp-muted);
  }

  .collapsible__list {
    margin: 0;
    padding-left: 18px;
    color: var(--cp-text2);
    line-height: 1.6;
  }

  .collapsible__list li {
    margin: var(--cp-space-1) 0;
  }

  .topic-playlists {
    margin-top: var(--cp-space-5);
  }

  .topic-playlists h2 {
    margin: 0 0 var(--cp-space-3);
  }

  .topic-playlists__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--cp-space-3);
  }

  .topic-playlist-card {
    display: block;
    padding: var(--cp-space-3) var(--cp-space-4);
    text-decoration: none;
    transition:
      background var(--cp-transition-fast) var(--cp-ease-out),
      border-color var(--cp-transition-fast) var(--cp-ease-out);
  }

  .topic-playlist-card:hover {
    background: color-mix(in srgb, var(--cp-text) 3%, transparent);
    border-color: var(--cp-accent);
  }

  .topic-playlist-card h3 {
    margin: 0;
    font-size: var(--cp-text-base);
    color: var(--cp-title);
  }

  .topic-playlist-card:hover h3 {
    color: var(--cp-title-strong);
  }

  .topic-playlist-card__meta {
    margin: var(--cp-space-1) 0 0;
    font-size: var(--cp-text-sm);
    color: var(--cp-muted);
  }

  @media (max-width: 600px) {
    .topic-hero {
      flex-direction: column;
      gap: var(--cp-space-3);
    }

    .topic-hero__icon {
      width: 56px;
      height: 56px;
    }
  }
</style>
