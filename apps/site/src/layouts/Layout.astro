---
import "../styles/global.css";
import KatexAutoRender from "../components/KatexAutoRender.astro";
import MobileNav from "../components/MobileNav.astro";

export type LayoutProps = {
  title?: string;
  hasMath?: boolean;
};

const { title = "Cosmic Playground", hasMath = true } = Astro.props;

const withBase = (path: string) => {
  const base = import.meta.env.BASE_URL;
  const normalizedBase = base.endsWith("/") ? base : `${base}/`;
  const normalizedPath = path.startsWith("/") ? path.slice(1) : path;
  return `${normalizedBase}${normalizedPath}`;
};

const currentPath = Astro.url.pathname;

function isActive(href: string) {
  const base = import.meta.env.BASE_URL || "/";
  const fullHref = href.startsWith("/") ? base + href.slice(1) : base + href;
  return currentPath.startsWith(fullHref);
}

const themeParam = Astro.url.searchParams.get("theme");
const isLightTheme =
  themeParam === "paper" ||
  Astro.url.pathname.includes("/instructor/") ||
  Astro.url.pathname.includes("/stations/");
---

<!doctype html>
<html lang="en" data-theme={isLightTheme ? "paper" : undefined}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{title}</title>
    <link rel="stylesheet" href={withBase("assets/katex/katex.min.css")} />
    <link rel="preload" href={withBase("fonts/Lexend.woff2")} as="font" type="font/woff2" crossorigin />
    <link rel="preload" href={withBase("fonts/SourceSans3.woff2")} as="font" type="font/woff2" crossorigin />
    <link rel="preload" href={withBase("fonts/Inter.woff2")} as="font" type="font/woff2" crossorigin />
    <style set:html={`
      @font-face {
        font-family: "Lexend";
        font-style: normal;
        font-weight: 100 900;
        font-display: swap;
        src: url("${withBase("fonts/Lexend.woff2")}") format("woff2");
      }
      @font-face {
        font-family: "Source Sans 3";
        font-style: normal;
        font-weight: 200 900;
        font-display: swap;
        src: url("${withBase("fonts/SourceSans3.woff2")}") format("woff2");
      }
      @font-face {
        font-family: "Source Sans 3";
        font-style: italic;
        font-weight: 200 900;
        font-display: swap;
        src: url("${withBase("fonts/SourceSans3-Italic.woff2")}") format("woff2");
      }
      @font-face {
        font-family: "Inter";
        font-style: normal;
        font-weight: 100 900;
        font-display: swap;
        src: url("${withBase("fonts/Inter.woff2")}") format("woff2");
      }
    `} />
  </head>
  <body class={isLightTheme ? "cp-layer-paper" : "cp-layer-museum"}>
    <a class="skip-link" href="#content">Skip to content</a>
    <header class="site-header cp-no-print">
      <div class="site-header__inner">
        <div class="brand">
          <a class="brand__name" href={withBase("")}>Cosmic Playground</a>
          <ul class="brand__cadence" aria-label="Predict, Play, Explain">
            <li>Predict</li>
            <li>Play</li>
            <li>Explain</li>
          </ul>
        </div>
        <nav class="desktop-nav" aria-label="Primary">
          <a
            href={withBase("explore/")}
            aria-current={isActive("/explore/") ? "page" : undefined}
          >
            Explore
          </a>
          <a
            href={withBase("playlists/")}
            aria-current={isActive("/playlists/") ? "page" : undefined}
          >
            Playlists
          </a>
          <a
            href={withBase("for-instructors/")}
            aria-current={isActive("/for-instructors/") ? "page" : undefined}
          >
            For Instructors
          </a>
          <a
            href={withBase("about/")}
            aria-current={isActive("/about/") ? "page" : undefined}
          >
            About
          </a>
        </nav>
        <MobileNav withBase={withBase} isActive={isActive} />
      </div>
    </header>
    <main id="content" class="site-main">
      <slot />
      {hasMath ? <KatexAutoRender /> : null}
    </main>
    <footer class="site-footer cp-no-print">
      <div class="site-footer__inner">
        <div class="site-footer__meta">
          <p class="site-footer__credit">Developed and designed by Anna Rosen.</p>
          <a class="site-footer__contact" href="mailto:alrosen@sdsu.edu">Contact</a>
        </div>
        <p class="site-footer__note">
          Built as a static “interactive museum” for astronomy demos. Instructor
          notes are public (v0.2 policy).
        </p>
      </div>
    </footer>
  </body>
</html>

<style>
  .desktop-nav a[aria-current="page"] {
    color: var(--cp-accent);
    border-bottom: 2px solid currentColor;
  }

  @media (max-width: 767px) {
    .desktop-nav {
      display: none;
    }
  }
</style>
